// Generated by CoffeeScript 1.12.2
var IndexCrtl, MenuCrtl, ModalInstanceCrtl, micontroller, IngresoCtrl, PerfilCrtl, PaginaCrtl,PedidosCrtl;

IndexCrtl = function($scope, rcClientIndex, $modal, rcCarrito) {
  $scope.nElementsCarro = localStorage.getItem("nElementsCarro");  
  return $scope.false;
};

MenuCrtl = function($scope,rcLoginCliente,rcClientIndex,$modal,rcPersonaUsuario,rcCarrito, Msg) {
  var getCategorias, getProductos, getSectores,getEspecificaciones;
  $scope.categorias = {};
  $scope.productos = {};
  $scope.especificaciones = {};
  $scope.rcLoginCliente = rcLoginCliente;
  $scope.rcCarrito = rcCarrito;

  getSectores = function() {
    return rcClientIndex.getSectores({}, function(r) {
      return $scope.sectores = r.data;
    });
  };

  getEspecificaciones = function() {
    return rcClientIndex.getEspecificaciones({}, function(r) {
      return $scope.especificaciones = r.data;
    });
  };

  getCategorias = function() {
    return rcClientIndex.getCategorias({}, function(r) {
      return $scope.categorias = r.data;
    });
  };

  getProductos = function() {
    return rcClientIndex.getProductos({}, function(r) {
      return $scope.productos = r.data;
    });
  };

  $scope.AddItemToCart = function(pro) {
    var modalInstance;
    if (pro.especificacion.length) {
      return modalInstance = $modal.open({
        templateUrl: 'seleccionEspecificacion.html',
        controller: 'ModalInstanceCrtl',
        size: "lg",
        backdrop: 'static',
        resolve: {
          data: function() {
            return {
              especificaciones: pro.especificacion
            };
          }
        }
      }).result.then(function(resultado) {
        return $scope.addItem(pro, resultado);
      }, function(close) {});
    } else {
      return $scope.addItem(pro, '');
    }
  };

  $scope.addItem = function(pro, resultado) {
    var especificaciones = $scope.especificaciones;
    var productos_carro = JSON.parse(localStorage.getItem("itemsCarro"));
    var cantidad_productos = 0;
    var codigo = "p"+pro.id+"e"+resultado;
    var monto_total = 0;
    if( !productos_carro ) {
      productos_carro = {};
    }
    if( localStorage.nElementsCarro ) {
      cantidad_productos = localStorage.nElementsCarro;
    }
    if( localStorage.precioTotal ) {
      monto_total = localStorage.precioTotal;
    }
    if( productos_carro[codigo] ) {
      productos_carro[codigo].cantidad++;
    } else {
      productos_carro[codigo] = pro;
      productos_carro[codigo].cantidad = 1;
      productos_carro[codigo].especificacionSeleccionada = resultado;
      if( resultado ){
        productos_carro[codigo].nombreEspecificacion = especificaciones[resultado].descripcion;
        productos_carro[codigo].precioEspecificacion = especificaciones[resultado].valor;
      } else {
        productos_carro[codigo].nombreEspecificacion = "";
        productos_carro[codigo].precioEspecificacion = 0;
      }
    }
    nuevo_monto = productos_carro[codigo].valor + productos_carro[codigo].precioEspecificacion;
    localStorage.precioTotal = parseInt(monto_total) + parseInt(nuevo_monto);
    localStorage.setItem("itemsCarro", JSON.stringify(productos_carro));
    rcCarrito.itemsCarro = productos_carro;
    cantidad_productos++;
    localStorage.nElementsCarro = cantidad_productos;
    $scope.rcCarrito.precioTotal = localStorage.precioTotal;
    Msg.Success("Producto agregado con éxito");
    return $scope.rcCarrito.nElementsCarro = cantidad_productos;
  };

  $scope.confirmarCompra = function() {
    var modalInstance;
    return modalInstance = $modal.open({
    templateUrl: 'resumen.html',
    controller: 'ModalInstanceCrtl',
    windowClass: 'app-modal-window',
    size: "lg",
    backdrop: 'static',
    resolve: {
      data: function() {
        return {
          resumen: JSON.parse(localStorage.getItem("itemsCarro"))
        };
      }
    }
    }).result.then(function(resultado) {

    }, function(close) {});
    
  };
  //PRUEBA MIA
  $scope.registrarUsuario = function() {
    var modalInstance;
    return modalInstance = $modal.open({
      templateUrl: 'formLoginCliente.html',
      controller: 'ModalInstanceCrtl',
      size: "lg",
      windowClass: 'app-modal-window',
      backdrop: 'static',
      resolve: {
        data: function() {
          return {
            resumen: "Algo debe hacerse. Llamar a un servicio o algo que haga el guardado"
          };
        }
      }
    }).result.then(function(resultado) {}, function(close) {});
  };

  $scope.validarAcceso = function(id) {
    return rcPersonaUsuario.getDataUsuario({
      id: id
    }, function(r) {
      if (r.success === true) {
        //return modal(r);
      } else {
        return Msg.Info("Sin datos");
      }
    }, function(error) {
      return Msg.Error();
    });
  };
  $scope.nuevo = function() {
    //return modal({});
  };

  getProductos();
  getEspecificaciones();
  return getCategorias();
};

ModalInstanceCrtl = function($scope,$modalInstance,data,$modal,rcCarrito,rcLoginCliente,registroCliente,finalizarCompra,rcPersonaUsuario,Msg,clienteDireccion,rcCompra,estadoUsuario) {
  $scope.data = data;
  $scope.observacion = "";
  $scope.rcCarrito = rcCarrito;
  $scope.clienteDireccion = clienteDireccion;
  $scope.rcLoginCliente = rcLoginCliente;
  $scope.registroCliente = registroCliente;
  $scope.finalizarCompra = finalizarCompra;
  $scope.direccionSeleccionada = "lll";
  $scope.estadoUsuario = estadoUsuario;


  $scope.aceptar = function(responce) {
    if (responce == null) {
      responce = true;
    }
    return $modalInstance.close(responce);
  };
  
  $scope.cancelar = function() {
    return $modalInstance.dismiss('cancel');
  };

  $scope.submitCompra = function(data, opcDir) {
    $scope.finalizarCompra.objRespuesta = JSON.stringify(data);
    $scope.finalizarCompra.opcNuevaDireccion = opcDir;
    if( opcDir == 1 ) {
      $scope.datosUsuario = localStorage.getItem("usuarioCliente");
      return rcCompra.ingresar({
        data:$scope.finalizarCompra.objRespuesta,
        opc_nueva:$scope.finalizarCompra.opcNuevaDireccion,
        sector: $scope.clienteDireccion.cSector,
        dir_calle: $scope.clienteDireccion.cDirCalle,
        dir_numero: $scope.clienteDireccion.cDirNumero,
        dir_detalle: $scope.clienteDireccion.cDirDetalle,
        datosUsuario: $scope.datosUsuario,
        observacion: $scope.finalizarCompra.observacion
      }, function(r) {
        if (r.success === true) {
          clienteDireccion.limpiar();
          localStorage.removeItem("usuarioCliente");
          localStorage.setItem("usuarioCliente", JSON.stringify(r.data));
          localStorage.removeItem('nElementsCarro');
          localStorage.removeItem('precioTotal');
          localStorage.removeItem('itemsCarro');
          $scope.rcCarrito.itemsCarro = {};
          $scope.rcCarrito.nElementsCarro = 0; 
          $scope.rcCarrito.precioTotal = 0;
          $scope.finalizarCompra.observacion = "";
          
          $modalInstance.close(r);
          Msg.Success(r.mensaje);
          window.location = '/index/mis-compras';
          return true;
        } else {
          $modalInstance.close(r);
          return Msg.Info(r.mensaje);
        }
      }, function(error) {
        $modalInstance.close(r);
        return Msg.Error();
      });
    } else {
      $scope.datosUsuario = localStorage.getItem("usuarioCliente");
      return rcCompra.ingresar({
        id_direccion: $scope.finalizarCompra.idDireccion,
        data:$scope.finalizarCompra.objRespuesta,
        opc_nueva:$scope.finalizarCompra.opcNuevaDireccion,
        datosUsuario: $scope.datosUsuario,
        observacion: $scope.finalizarCompra.observacion
      }, function(r) {
        if (r.success === true) {
          localStorage.removeItem('nElementsCarro');
          localStorage.removeItem('precioTotal');
          localStorage.removeItem('itemsCarro');
          $scope.rcCarrito.itemsCarro = {};
          $scope.rcCarrito.nElementsCarro = 0; 
          $scope.rcCarrito.precioTotal = 0;
          $scope.finalizarCompra.observacion = "";
          $modalInstance.close(r);
          Msg.Success(r.mensaje);
          window.location = '/index/mis-compras';
          return true;
        } else {
          $modalInstance.close(r);
          return Msg.Info(r.mensaje);
        }
      }, function(error) {
        $modalInstance.close(r);
        return Msg.Error();
      });
    }
  };
 
  $scope.enviarPedido = function(response) {
    if( !localStorage.usuarioCliente ) {
      var modalInstance;
      $modalInstance.close(response);
      return modalInstance = $modal.open({
        templateUrl: 'formLoginCliente.html',
        controller: 'ModalInstanceCrtl',
        windowClass: 'app-modal-window',
        size: "lg",
        backdrop: 'static',
        resolve: {
          data: function() {
            return {
              resumen: JSON.parse(localStorage.getItem("itemsCarro")),
              comprador: JSON.parse(localStorage.getItem("usuarioCliente"))
            };
          }
        }
      }).result.then(function(resultado) {}, function(close) {});
    } else {
      $modalInstance.close(response);
        return modalInstance = $modal.open({
          templateUrl: 'confirmarPedido.html',
          controller: 'ModalInstanceCrtl',
          windowClass: 'app-modal-window',
          size: "lg",
          backdrop: 'static',
          resolve: {
            data: function() {
              return {
                resumen: JSON.parse(localStorage.getItem("itemsCarro")),
                comprador: JSON.parse(localStorage.getItem("usuarioCliente")),
                direccionSeleccionada: $scope.direccionSeleccionada
              };
            }
          }
        }).result.then(function(resultado) {}, function(close) {});
      alert("Ya está logueado");
    }
    if (response == null) {
      response = true;
    }
    return $modalInstance.close(response);
  };


  $scope.enviarComentario = function(response) {
    var modalInstance;
    $modalInstance.close(response);
    return modalInstance = $modal.open({
      templateUrl: 'agregarObservacion.html',
      controller: 'ModalInstanceCrtl',
      windowClass: 'app-modal-window',
      size: "lg",
      backdrop: 'static',
      resolve: {
        data: function() {
          return {
            observacion: $scope.observacion
          };
        }
      }
    }).result.then(function(resultado) {}, function(close) {});
   
    if (response == null) {
      response = true;
    }
    return $modalInstance.close(response);
  };




  $scope.vaciarCarro = function(response) {
    localStorage.removeItem("itemsCarro");
    localStorage.removeItem("nElementsCarro");
    localStorage.removeItem("precioTotal");
    $modalInstance.close(response);
    $scope.rcCarrito.nElementsCarro = 0; 
    $scope.rcCarrito.itemsCarro = ""; 
    $scope.rcCarrito.precioTotal = 0;

    //window.location = '/index/menu';
    Msg.Success("El carro de compras ha sido vaciado");
  }

  $scope.submitLoginForm = function() {
    return rcPersonaUsuario.getDataUsuario({
      correo: $scope.rcLoginCliente.loginEmail,
      password: $scope.rcLoginCliente.loginPassword 
    }, function(r) {
      if (r.success === true) {
        localStorage.setItem("usuarioCliente", JSON.stringify(r.data));
        $scope.estadoUsuario.nombreUsuario = r.data.nombre;
        $scope.estadoUsuario.usuario = true;
        $modalInstance.close(r);
        Msg.Success(r.mensaje);
        return modalInstance = $modal.open({
          templateUrl: 'confirmarPedido.html',
          controller: 'ModalInstanceCrtl',
          windowClass: 'app-modal-window',
          size: "lg",
          backdrop: 'static',
          resolve: {
            data: function() {
              return {
                resumen: JSON.parse(localStorage.getItem("itemsCarro")),
                comprador: JSON.parse(localStorage.getItem("usuarioCliente"))
              };
            }
          }
        }).result.then(function(resultado) {}, function(close) {});
      } else {
        Msg.Error(r.mensaje);
      }
    }, function(error) {
      return Msg.Error();
    });
  };

  $scope.seleccionarOpc = function (seleccionado) {
    $scope.data.seleccion = seleccionado;
  };

  $scope.seleccionarDireccion = function (seleccionado) {
    $scope.data.seleccionDir = seleccionado;
    $scope.finalizarCompra.idDireccion = seleccionado;
  };

  $scope.registrarCliente = function(responce) {
    if( !localStorage.usuarioCliente ) {   
      var modalInstance;
      $modalInstance.close(responce);
      return modalInstance = $modal.open({
        templateUrl: 'formRegistroCliente.html',
        controller: 'ModalInstanceCrtl',
        windowClass: 'app-modal-window',
        size: "lg",
        backdrop: 'static',
        resolve: {
          data: function() {
            return {
              resumen: "Algo debe hacerse. Llamar a un servicio o algo que haga el guardado"
            };
          }
        }
      }).result.then(function(resultado) {
      }, function(close) {});
     
    } else {
      alert("Ya está logueado");
    }
    if (responce == null) {
      responce = true;
    }
    return $modalInstance.close(responce);
  };

  $scope.submitRegistroForm = function() {
    return rcPersonaUsuario.registrar({
      correo: $scope.registroCliente.rEmail,
      password: $scope.registroCliente.rPassword,
      nombres:$scope.registroCliente.rNombres,
      apellidos:$scope.registroCliente.rApellidos,
      telefono:$scope.registroCliente.rTelefono,
      sector:$scope.registroCliente.rSector,
      dir_calle:$scope.registroCliente.rDirCalle,
      dir_numero:$scope.registroCliente.rDirNumero,
      dir_detalle:$scope.registroCliente.rDirDetalle
    }, function(r) {
      if (r.success === true) {
        localStorage.setItem("usuarioCliente", JSON.stringify(r.data));
        $scope.estadoUsuario.nombreUsuario = r.data.nombre;
        $scope.estadoUsuario.usuario = true;
        Msg.Success(r.mensaje);
        $modalInstance.close(r);
        return modalInstance = $modal.open({
          templateUrl: 'confirmarPedido.html',
          controller: 'ModalInstanceCrtl',
          windowClass: 'app-modal-window',
          size: "lg",
          backdrop: 'static',
          resolve: {
            data: function() {
              return {
                resumen: JSON.parse(localStorage.getItem("itemsCarro")),
                comprador: JSON.parse(localStorage.getItem("usuarioCliente"))
              };
            }
          }
        }).result.then(function(resultado) {}, function(close) {});

      } else {
        return Msg.Info(r.mensaje);
      }
    }, function(error) {
      
      return Msg.Error();
    });
  };

  $scope.pedidoNuevaDireccion = function(responce) {
    return modalInstance = $modal.open({
        templateUrl: '/index/modal-confirmar',
        controller: 'ModalInstanceCrtl',
        size: "md",
        backdrop: 'static',
        resolve: {
          data: function() {
            return {};
          }
        }
      }).result.then(function(resultado) {
        $scope.datosUsuario = localStorage.getItem("usuarioCliente");
        return rcPersonaUsuario.crearDireccion({
          sector: clienteDireccion.dirSector,
          calle: clienteDireccion.dirCalle,
          numero: clienteDireccion.dirNumero,
          detalle: clienteDireccion.dirDetalle,
          datosUsuario: $scope.datosUsuario
        }, function(r) {
          if (r.success === true) {
            clienteDireccion.limpiar();
            localStorage.removeItem("usuarioCliente");
            localStorage.setItem("usuarioCliente", JSON.stringify(r.data));
            var data_perfil = JSON.parse(localStorage.getItem("usuarioCliente"));
            $scope.datosUsuario =  JSON.stringify(r.data);
            $scope.direcciones = data_perfil.direccion;
            Msg.Success(r.mensaje);
          } else {
            clienteDireccion.limpiar();
            Msg.Error(r.mensaje);
          }
        }, function(error) {
          clienteDireccion.limpiar();
          return Msg.Error();
        });
      }, function(close) {
        clienteDireccion.limpiar();
        return Msg.Info("Accion cancelada");
      });
    return $modalInstance.close(responce);
  };
};

micontroller = function($scope) {
  return console.log("asdas");
};

IngresoCrtl = function($scope, rcClientIndex, $modal, rcLoginCliente, registroCliente, rcPersonaUsuario,Msg,estadoUsuario) {
  $scope.rcLoginCliente = rcLoginCliente;
  $scope.registroCliente = registroCliente;
  $scope.estadoUsuario = estadoUsuario;
  $scope.rcLoginCliente.limpiar();
  $scope.registroCliente.limpiar();

  $scope.loginForm = function() {
    return rcPersonaUsuario.getDataUsuario({
      correo: $scope.rcLoginCliente.loginEmail,
      password: $scope.rcLoginCliente.loginPassword 
    }, function(r) {
      if (r.success === true) {
        localStorage.setItem("usuarioCliente", JSON.stringify(r.data));
        //$modalInstance.close(r);
        $scope.estadoUsuario.nombreUsuario = r.data.nombre;
        $scope.estadoUsuario.usuario = true;

        Msg.Success(r.mensaje);
        window.location = '/index/inicio';
        return $location.path('/index');
      } else {
        Msg.Error(r.mensaje);
      }
    }, function(error) {
      return Msg.Error();
    });
  };

  $scope.registroForm = function() {
    return rcPersonaUsuario.registrar({
      correo: $scope.registroCliente.rEmail,
      password: $scope.registroCliente.rPassword,
      nombres:$scope.registroCliente.rNombres,
      apellidos:$scope.registroCliente.rApellidos,
      telefono:$scope.registroCliente.rTelefono,
      sector:$scope.registroCliente.rSector,
      dir_calle:$scope.registroCliente.rDirCalle,
      dir_numero:$scope.registroCliente.rDirNumero,
      dir_detalle:$scope.registroCliente.rDirDetalle
    }, function(r) {
      if (r.success === true) {
        localStorage.setItem("usuarioCliente", JSON.stringify(r.data));
        Msg.Success(r.mensaje);
        window.location = '/index/mi-perfil';
        return $location.path('/index');
      } else {
        Msg.Error(r.mensaje);
      }
    }, function(error) {
      return Msg.Error();
    });
  };

  $scope.pasoSiguiente = function() {
    $scope.registroCliente.paso = 2;
    return true;
  };

  $scope.pasoAnterior = function() {
    $scope.registroCliente.paso = 1;
    return true;
  };
}


PerfilCrtl = function($scope, $modal, Msg, rcPersonaUsuario,clienteDireccion) {
  var modalInstance;
  $scope.email = "";
  $scope.nombre = "";
  $scope.apellido = "";
  $scope.telefono = "";
  $scope.direcciones = "";
  $scope.idPersona = "";
  $scope.datosUsuario = "";
  
  $scope.rcPersonaUsuario = rcPersonaUsuario;
  $scope.clienteDireccion = clienteDireccion;

  if( localStorage.getItem("usuarioCliente") ) {
    var data_perfil = JSON.parse(localStorage.getItem("usuarioCliente"));
    $scope.email = data_perfil.username;
    $scope.nombre = data_perfil.nombre;
    $scope.apellido = data_perfil.apPaterno;
    $scope.telefono = data_perfil.celular;
    $scope.direcciones = data_perfil.direccion;
    $scope.idPersona = data_perfil.id_persona;
  }

  $scope.editarPerfil = function() {
    var modalInstance;
    return modalInstance = $modal.open({
      templateUrl: '/index/modal-confirmar',
      controller: 'ModalInstanceCrtl',
      size: "md",
      backdrop: 'static',
      resolve: {
        data: function() {
          return {};
        }
      }
    }).result.then(function(resultado) {
      return rcPersonaUsuario.edit({
        correo: $scope.email,
        nombres: $scope.nombre,
        apellidos: $scope.apellido,
        telefono: $scope.telefono
      }, function(r) {
        if (r.success === true) {
          localStorage.removeItem("usuarioCliente");
          localStorage.setItem("usuarioCliente", JSON.stringify(r.data));
          Msg.Success(r.mensaje);
        } else {
          Msg.Error(r.mensaje);
        }
      }, function(error) {
        return Msg.Error();
      });
    }, function(close) {
      return Msg.Info("Accion cancelada");
    });
  };

  $scope.rellenarDatosUsuario = function() {
    var data_perfil = JSON.parse(localStorage.getItem("usuarioCliente"));
    $scope.email = data_perfil.username;
    $scope.nombre = data_perfil.nombre;
    $scope.apellido = data_perfil.apPaterno;
    $scope.telefono = data_perfil.celular;
    $scope.direcciones = data_perfil.direccion;
    $scope.idPersona = data_perfil.id_persona;
    return false;
  };

  $scope.nuevaDireccion = function() {
    var modalInstance;  
    return modalInstance = $modal.open({
      templateUrl: 'formNuevaDireccion.html',
      controller: 'ModalInstanceCrtl',
      windowClass: 'app-modal-window',
      size: "lg",
      backdrop: 'static',
      resolve: {
        data: function() {
          return {
            //resumen: JSON.parse(localStorage.getItem("itemsCarro")),
            //comprador: JSON.parse(localStorage.getItem("usuarioCliente"))
          };
        }
      }
    }).result.then(function(resultado) {
      return modalInstance = $modal.open({
        templateUrl: '/index/modal-confirmar',
        controller: 'ModalInstanceCrtl',
        size: "md",
        backdrop: 'static',
        resolve: {
          data: function() {
            return {};
          }
        }
      }).result.then(function(resultado) {
        $scope.datosUsuario = localStorage.getItem("usuarioCliente");
        return rcPersonaUsuario.crearDireccion({
          sector: clienteDireccion.dirSector,
          calle: clienteDireccion.dirCalle,
          numero: clienteDireccion.dirNumero,
          detalle: clienteDireccion.dirDetalle,
          datosUsuario: $scope.datosUsuario
        }, function(r) {
          if (r.success === true) {
            clienteDireccion.limpiar();
            localStorage.removeItem("usuarioCliente");
            localStorage.setItem("usuarioCliente", JSON.stringify(r.data));
            var data_perfil = JSON.parse(localStorage.getItem("usuarioCliente"));
            $scope.datosUsuario =  JSON.stringify(r.data);
            $scope.direcciones = data_perfil.direccion;
            Msg.Success(r.mensaje);
          } else {
            clienteDireccion.limpiar();
            Msg.Error(r.mensaje);
          }
        }, function(error) {
          clienteDireccion.limpiar();
          return Msg.Error();
        });
      }, function(close) {
        clienteDireccion.limpiar();
        return Msg.Info("Accion cancelada");
      });
      
    }, function(close) {});
      clienteDireccion.limpiar();
  };


  $scope.eliminar = function(id) {
    var modalInstance;
    var datosUsuario = localStorage.getItem("usuarioCliente");
    var data_perfil = JSON.parse(localStorage.getItem("usuarioCliente"));

    if( parseInt(data_perfil.numero_direcciones) > 1 ) {


      return modalInstance = $modal.open({
        templateUrl: '/index/modal-confirmar',
        controller: 'ModalInstanceCrtl',
        size: "md",
        backdrop: 'static',
        resolve: {
          data: function() {
            return {
              id:id,
              datosUsuario: datosUsuario 
            };
          }
        }
      }).result.then(function(resultado) {

        return rcPersonaUsuario.eliminarDireccion({
          id_direccion: id,
          datosUsuario: datosUsuario
        }, function(r) {
          if (r.success === true) {
            localStorage.removeItem("usuarioCliente");
            localStorage.setItem("usuarioCliente", JSON.stringify(r.data));
            var data_perfil = JSON.parse(localStorage.getItem("usuarioCliente"));
            $scope.datosUsuario =  JSON.stringify(r.data);
            $scope.direcciones = data_perfil.direccion;
            Msg.Success(r.mensaje);
          } else {
            Msg.Error(r.mensaje);
          }
        }, function(error) {
          return Msg.Error();
        });
      }, function(close) {
        return Msg.Info("Accion cancelada");
      });
    } else {
      return Msg.Info("No se puede eliminar. Debe registrar al menos una dirección");
    } 
  };

    return false;
}

PaginaCrtl = function($scope,$modal, Msg, estadoUsuario) {

  $scope.estadoUsuario = estadoUsuario;
  $scope.logout = function() {
    var modalInstance;
    return modalInstance = $modal.open({
      templateUrl: '/index/modal-confirmar',
      controller: 'ModalInstanceCrtl',
      size: "md",
      backdrop: 'static',
      resolve: {
        data: function() {
          return {};
        }
      }
    }).result.then(function(resultado) {
      localStorage.removeItem('usuarioCliente');
      Msg.Success("Acción realizada con éxito");
      $scope.estadoUsuario.nombreUsuario = "";
      $scope.estadoUsuario.usuario = false;
      window.location = '/index/inicio';
      return $location.path("/index/inicio");
    }, function(close) {
      return Msg.Info("Acción cancelada");
    });
  };

  return false;
}

PedidosCrtl = function($scope, $modal, Msg, rcCompra) {
  var modalInstance;
  $scope.compras = {};
  $scope.poseeCompras = false;
  $scope.idPersona = null;
  if( localStorage.getItem("usuarioCliente") ) {
    var data_perfil = JSON.parse(localStorage.getItem("usuarioCliente"));
    $scope.idPersona = data_perfil.id_persona;
  }

  getCompras = function() {
    if( $scope.idPersona ) {
      return rcCompra.getCompras({
        id_persona: $scope.idPersona
      }, function(r) {
        if (r.success === true) {
          if( r.nRegistros ) {
            $scope.poseeCompras = true;
          }
          return $scope.compras = r.data;
        } else {
          Msg.Info(r.mensaje);
          window.location = '/index/inicio';
        }
      }, function(error) {
        Msg.Error(r.mensaje);
        window.location = '/index/inicio';
      });
    } else {
      Msg.Info("Debes iniciar sesión para esto");
      window.location = '/index/ingreso';
    }     
  };

  $scope.anularCompra = function(id_compra) {
    var modalInstance;
    return modalInstance = $modal.open({
      templateUrl: '/index/modal-confirmar',
      controller: 'ModalInstanceCrtl',
      size: "md",
      backdrop: 'static',
      resolve: {
        data: function() {
          return {};
        }
      }
    }).result.then(function(resultado) {
      return rcCompra.anular({
        id_compra: id_compra
      }, function(r) {
        if (r.success === true) {
          Msg.Success(r.mensaje);
          window.location = '/index/mis-compras';
        } else {
          Msg.Error(r.mensaje);
          window.location = '/index/mis-compras';
        }
      }, function(error) {
        Msg.Error(r.mensaje);
        window.location = '/index/mis-compras';
      });
    }, function(close) {
      return Msg.Info("Accion cancelada");
    });
  };

  $scope.preparaFecha = function(fecha) {
    var date = new Date(fecha);
    return date;
    //return "10 de Octubre "+fecha;
  };

  return getCompras();
}